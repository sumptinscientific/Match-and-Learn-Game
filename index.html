<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Sumptin‚Äô Scientific ‚Äî Match & Learn</title>
<meta name="theme-color" content="#0f4a4e">
<style>
  :root{
    --bg:#0f4a4e;        /* deep teal */
    --panel:#0b3b3f;    /* darker teal */
    --cream:#f6ecd6;    /* warm cream for text */
    --amber:#d08a1b;    /* warm amber (distinct from bright yellow) */
    --mint:#6ab9b6;     /* accent teal */
    --correct:#2aa36b;
    --wrong:#d34b57;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--cream);
    font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  header{
    padding:14px 16px;
    display:flex;gap:12px;align-items:center;justify-content:space-between;
    background:linear-gradient(180deg,var(--panel),transparent);
    position:sticky;top:0;z-index:10;
    border-bottom:1px solid rgba(255,255,255,.07);
  }
  .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.2px}
  .bulb{
    width:28px;height:28px;border-radius:50%;
    position:relative;background:radial-gradient(circle at 35% 35%, #ffdca8 0 30%, var(--amber) 31%, #9c6610 100%);
    box-shadow:0 0 20px rgba(208,138,27,.35);
    flex:0 0 auto;
  }
  .bulb:after{
    content:""; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%);
    width:16px; height:6px; border-radius:4px; background:var(--amber);
    box-shadow:0 -7px 0 0 var(--amber), 0 -14px 0 0 var(--amber);
  }
  h1{margin:.2rem 0;font-size:1.2rem}
  .subtitle{opacity:.9;margin-top:2px;font-size:.9rem}

  main{padding: 12px 14px; max-width:1100px; margin:0 auto;}
  .board{display:grid; gap:12px; grid-template-columns: 1fr;}
  @media (min-width: 940px){ .board{grid-template-columns: 360px 1fr;} }

  .panel{
    background:rgba(0,0,0,.14);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,.12);
  }

  label{display:block;margin:.5rem 0 .25rem .1rem;opacity:.9;font-size:.95rem}
  select,button,input[type="range"]{
    width:100%;padding:14px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
    background:#123c40;color:var(--cream);outline:none;font-size:1rem;
  }
  button.cta{
    background:linear-gradient(180deg,var(--amber),#b87a19);
    color:#231b14;border:none;font-weight:800;letter-spacing:.3px;cursor:pointer;
  }
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .row > *{flex:1}

  .stats{display:flex; gap:8px; flex-wrap:wrap; margin:.6rem 0 0}
  .stat{background:#123c40;border:1px solid rgba(255,255,255,.12); padding:.45rem .6rem; border-radius:10px; font-weight:700; font-size:.95rem}

  /* Touch-friendly grid */
  .grid{display:grid; gap:10px; margin-top:10px; grid-template-columns: 1fr;}
  @media (min-width:560px){ .grid{grid-template-columns:1fr 1fr} }
  @media (min-width:1024px){ .grid{grid-template-columns:repeat(3,1fr)} }

  .card{
    background:#0c3134;
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:16px;
    min-height:60px;
    display:flex;align-items:center;justify-content:center;text-align:center;
    user-select:none; -webkit-user-select:none;
    touch-action:manipulation;
    transition: background .18s ease, transform .08s ease;
    font-size:1.02rem; line-height:1.3;
  }
  .card.term{background:#123c40}
  .card.definition{background:#0f2c2f}
  .card.selected{outline:3px solid var(--mint); transform:scale(0.995)}
  .card.correct{background:rgba(42,163,107,.2); border-color:rgba(42,163,107,.65)}
  .card.wrong{background:rgba(211,75,87,.18); border-color:rgba(211,75,87,.55)}

  .footer{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; opacity:.9}
  .hidden{display:none}

  .toast{
    position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
    background:#102f33; border:1px solid rgba(255,255,255,.1);
    padding:.6rem .9rem; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,.2);
    opacity:0; pointer-events:none; transition:.25s opacity, .25s transform;
    font-size:.95rem;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

  .end-screen{ text-align:center; padding:24px 12px }
  .score-xl{font-size:2rem; font-weight:900; margin-top:6px}
  .pill{display:inline-block; padding:.25rem .6rem; border-radius:100px; background:#123c40; border:1px solid rgba(255,255,255,.15); margin:4px 4px}
  .muted{opacity:.75}

  /* Settings drawer + overlay */
  .drawer{
    position:fixed; right:0; top:0; height:100%; width:min(92vw, 420px);
    background:#0b3b3f; border-left:1px solid rgba(255,255,255,.12);
    box-shadow:-6px 0 24px rgba(0,0,0,.25);
    transform:translateX(100%); transition:.25s transform; z-index:30; padding:16px;
    overflow:auto;
  }
  .drawer.open{ transform:translateX(0) }
  .drawer h2{margin:6px 0 10px}
  .toggle{display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.12)}
  .drawer .closebtn{position:absolute; top:10px; right:12px; background:#123c40; border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:8px 10px; cursor:pointer}
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter: blur(1px);
    opacity:0; pointer-events:none; transition:.2s opacity; z-index:25;
  }
  .overlay.show{ opacity:1; pointer-events:auto }

  /* Footer bar */
  .site-footer{
    margin:16px auto 22px;
    max-width:1100px;
    padding:10px 14px;
    display:flex; gap:8px; align-items:center; justify-content:center;
    opacity:.85; font-size:.92rem;
    border-top:1px solid rgba(255,255,255,.08);
  }
  .site-footer a{color:var(--mint); text-decoration:none}
  .site-footer a:hover{text-decoration:underline}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="bulb" aria-hidden="true"></div>
    <div>
      <div style="font-size:1.05rem">Sumptin‚Äô Scientific</div>
      <div class="subtitle">Match & Learn ‚Äî built for mobile</div>
    </div>
  </div>
  <div class="row" style="max-width:420px">
    <button id="shareBtn" title="Share" style="flex:0 0 auto;background:#123c40">Share</button>
    <button id="settingsBtn" title="Settings" style="flex:0 0 auto;background:#123c40">Settings</button>
  </div>
</header>

<main>
  <div class="board">
    <section class="panel">
      <h1>Choose Your Challenge</h1>
      <p class="subtitle">Tap to match terms with their definitions before time runs out. Bigger buttons, faster flow, pocket‚Äëfriendly.</p>

      <label for="subject">Subject</label>
      <select id="subject"></select>

      <label for="topic">Topic</label>
      <select id="topic"><option value="all">All topics</option></select>

      <div class="row">
        <div>
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option value="easy">Easy ‚Äî more time, foundational terms</option>
            <option value="medium" selected>Medium ‚Äî balanced time, mixed terms</option>
            <option value="hard">Hard ‚Äî quick timer, advanced terms</option>
          </select>
        </div>
        <div>
          <label for="pairCount">Pairs per round</label>
          <select id="pairCount">
            <option value="6">6</option>
            <option value="8" selected>8</option>
            <option value="10">10</option>
            <option value="12">12</option>
          </select>
        </div>
      </div>

      <div class="stats">
        <div class="stat" id="timer">‚è±Ô∏è 00:00</div>
        <div class="stat" id="score">‚≠ê Score: 0</div>
        <div class="stat" id="streak">üî• Streak: 0</div>
        <div class="stat" id="highScore">üèÜ High: 0</div>
      </div>

      <div class="footer">
        <button class="cta" id="startBtn">Start Game</button>
        <div class="muted" id="pairsInfo"></div>
      </div>

      <div style="margin-top:10px">
        <h3 style="margin:.2rem 0">Leaderboard (website)</h3>
        <div id="leaderboard" class="muted" style="font-size:.95rem"></div>
      </div>
    </section>

    <section class="panel">
      <div id="gameArea">
        <div class="grid" id="grid"></div>
        <div class="end-screen hidden" id="endScreen">
          <h2>Time!</h2>
          <div class="score-xl" id="finalScore">Score: 0</div>
          <p id="finalMsg" class="muted"></p>
          <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
            <button class="cta" id="playAgain">Play Again</button>
            <button id="revealAnswers" style="background:#123c40;border:1px solid rgba(255,255,255,.15);color:var(--cream);padding:12px 14px;border-radius:12px;font-size:1rem">Show Answer Key</button>
          </div>
          <div id="answerKey" class="hidden" style="text-align:left;margin-top:14px"></div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Footer -->
<div class="site-footer">
  <span>Made for Sumptin‚Äô Scientific | ¬© 2025 Sumptin‚Äô Scientific | </span>
  <a href="https://www.sumptinscientific.com" target="_blank" rel="noopener noreferrer">www.sumptinscientific.com</a>
</div>

<!-- Settings Drawer & Overlay -->
<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer" aria-hidden="true" aria-label="Settings">
  <button class="closebtn" id="closeDrawer" title="Close">Close ‚úï</button>
  <h2>Settings</h2>
  <div class="toggle">
    <span>Sound effects</span>
    <label>
      <input type="checkbox" id="soundToggle" checked />
      <span> On</span>
    </label>
  </div>
  <div class="toggle">
    <span>Timer multiplier</span>
    <div style="min-width:42%">
      <input type="range" id="timeMultiplier" min="0.5" max="1.5" step="0.1" value="1" />
      <div class="muted" id="timeMultLabel">1.0√ó</div>
    </div>
  </div>
  <div class="toggle">
    <span>Theme accent</span>
    <select id="themeAccent">
      <option value="mint" selected>Mint</option>
      <option value="amber">Amber</option>
      <option value="cream">Cream</option>
    </select>
  </div>
</aside>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ======= CONFIG =======
   Provide a Google Sheet CSV URL (published) for curriculum, like:
   https://docs.google.com/spreadsheets/d/XXXX/export?format=csv
   Columns required: subject,topic,term,definition,difficulty,source,attribution
*/
const SHEET_CSV_URL = https://docs.google.com/spreadsheets/d/e/2PACX-1vS-PG2q3opBVS6PdDcPK_NEnMHJax2eAKPUv[‚Ä¶]fWQz_GFuj2yMj1IwupZipivpIl/pubhtml?gid=1647137487&single=true;

/* Global leaderboard endpoint (Google Apps Script web app URL) */
const LEADERBOARD_URL = https://script.google.com/macros/s/AKfycbyWKgSJTbgXyijRGpMKQlkVMVX_q7-XrVd0tszkaz6uKkUZl8n46_xuVgo37Yx7fIRS/exec;

/* ======= SOUND via WebAudio ======= */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
}
function tone(freq=440, dur=0.12, type='sine', gain=0.12){
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}
function ding(){
  // little arpeggio
  tone(523.25,0.09,'sine',0.12);
  setTimeout(()=>tone(659.25,0.09,'sine',0.12), 90);
  setTimeout(()=>tone(783.99,0.11,'sine',0.12), 180);
}
function buzz(){
  tone(120,0.18,'square',0.09);
  setTimeout(()=>tone(100,0.18,'square',0.08), 120);
}
function tick(){
  tone(800,0.05,'triangle',0.06);
}

/* SFX toggles */
function playDing(){ if(document.getElementById('soundToggle').checked) ding(); }
function playBuzz(){ if(document.getElementById('soundToggle').checked) buzz(); }
function playTick(){ if(document.getElementById('soundToggle').checked) tick(); }
function playClick(){ if(document.getElementById('soundToggle').checked) tone(420,0.04,'sine',0.05); }
function playSelect(){ if(document.getElementById('soundToggle').checked) tone(520,0.05,'triangle',0.06); }

document.addEventListener('click', e => {
  const isInteractive = e.target.closest('button, .card, a, .closebtn, select');
  if(isInteractive) playClick();
});
document.addEventListener('change', e => {
  if(e.target.matches('select,input[type="range"],input[type="checkbox"]')) playSelect();
});

/* ======= Default built-in dataset =======
   Restores original subjects (Cell Biology, Genetics, Microbiology, Human Anatomy & Physiology, Biochemistry, Ecology, Neuroscience)
   and adds: Biology, Physics, Chemistry, Organic Chemistry, Nutrition, Psychology.
   This is minimal seed data to run immediately.
*/
const BUILTIN = [
  // Original subjects (seed)
  {subject:"Cell Biology", topic:"Organelles", term:"Mitochondrion", definition:"Organelle producing ATP via oxidative phosphorylation.", difficulty:"easy"},
  {subject:"Cell Biology", topic:"Cytoskeleton", term:"Microtubule", definition:"Hollow polymers forming mitotic spindle and transport tracks.", difficulty:"hard"},
  {subject:"Genetics", topic:"Basics", term:"Gene", definition:"DNA sequence encoding a functional product.", difficulty:"easy"},
  {subject:"Microbiology", topic:"Bacteria", term:"Gram‚Äëpositive", definition:"Thick peptidoglycan cell wall; retains crystal violet.", difficulty:"easy"},
  {subject:"Human Anatomy & Physiology", topic:"Neuro", term:"Action Potential", definition:"Rapid depolarization/repolarization in excitable cells.", difficulty:"medium"},
  {subject:"Biochemistry", topic:"Metabolism", term:"Glycolysis", definition:"Pathway converting glucose to pyruvate with ATP gain.", difficulty:"easy"},
  {subject:"Ecology", topic:"Communities", term:"Keystone Species", definition:"Species with disproportionate effect on community structure.", difficulty:"medium"},
  {subject:"Neuroscience", topic:"Cells", term:"Neuron", definition:"Electrically excitable cell that processes information.", difficulty:"easy"},

  // New required subjects (seed)
  {subject:"Biology", topic:"Cell Cycle", term:"Mitosis", definition:"Division of nucleus yielding identical daughter nuclei.", difficulty:"medium", attribution:"OpenStax Biology 2e (CC BY 4.0)", source:"openstax.org"},
  {subject:"Physics", topic:"Kinematics", term:"Velocity", definition:"Rate of change of displacement.", difficulty:"easy"},
  {subject:"Chemistry", topic:"Equilibrium", term:"Le Ch√¢telier‚Äôs Principle", definition:"System shifts to counteract imposed change.", difficulty:"medium"},
  {subject:"Organic Chemistry", topic:"Mechanisms", term:"SN2", definition:"Bimolecular substitution with backside attack, inversion.", difficulty:"hard"},
  {subject:"Nutrition", topic:"Macronutrients", term:"Protein", definition:"Amino acid polymers; 4 kcal/g; structural and functional roles.", difficulty:"easy"},
  {subject:"Psychology", topic:"Learning", term:"Classical Conditioning", definition:"Learning via association between stimuli.", difficulty:"easy"}
];

/* ======= Curriculum loading ======= */
let DATA = {}; // subject -> list of {term,def,difficulty,topics:[topic], attribution, source}
async function loadCurriculum(){
  if(SHEET_CSV_URL){
    try{
      const res = await fetch(SHEET_CSV_URL, {cache:'no-store'});
      const text = await res.text();
      DATA = csvToData(text);
      if(Object.keys(DATA).length) return;
    }catch(e){
      console.warn("CSV load failed, falling back to built-in", e);
    }
  }
  // Fallback to built-in
  DATA = {};
  for(const row of BUILTIN){
    if(!DATA[row.subject]) DATA[row.subject] = [];
    DATA[row.subject].push({
      term: row.term, def: row.definition, diff: row.difficulty || 'medium',
      topics: [row.topic || 'General'], attribution: row.attribution||"", source: row.source||""
    });
  }
}

/* CSV to internal data */
function csvToData(csv){
  const lines = csv.split(/\r?\n/).filter(Boolean);
  const header = lines.shift().split(',').map(h=>h.trim().toLowerCase());
  const idx = (name)=>header.indexOf(name);
  const m = {};
  for(const ln of lines){
    const cells = splitCsvLine(ln);
    const subject = (cells[idx('subject')]||'').trim();
    const topic = (cells[idx('topic')]||'General').trim();
    const term = (cells[idx('term')]||'').trim();
    const definition = (cells[idx('definition')]||'').trim();
    const difficulty = (cells[idx('difficulty')]||'medium').trim().toLowerCase();
    const source = (cells[idx('source')]||'').trim();
    const attribution = (cells[idx('attribution')]||'').trim();
    if(!subject || !term || !definition) continue;
    if(!m[subject]) m[subject] = [];
    m[subject].push({term, def:definition, diff:difficulty, topics:[topic], source, attribution});
  }
  return m;
}
function splitCsvLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; }
      else inQ=!inQ;
    }else if(ch===',' && !inQ){ out.push(cur); cur=""; }
    else cur+=ch;
  }
  out.push(cur);
  return out;
}

/* ======= UI bindings & engine (similar to previous version) ======= */
const subjectSel = document.getElementById('subject');
const topicSel = document.getElementById('topic');
const difficultySel = document.getElementById('difficulty');
const pairCountSel = document.getElementById('pairCount');
const startBtn = document.getElementById('startBtn');
const grid = document.getElementById('grid');
const timerEl = document.getElementById('timer');
const scoreEl = document.getElementById('score');
const streakEl = document.getElementById('streak');
const highScoreEl = document.getElementById('highScore');
const pairsInfo = document.getElementById('pairsInfo');
const toast = document.getElementById('toast');
const endScreen = document.getElementById('endScreen');
const finalScore = document.getElementById('finalScore');
const finalMsg = document.getElementById('finalMsg');
const playAgain = document.getElementById('playAgain');
const revealAnswersBtn = document.getElementById('revealAnswers');
const answerKey = document.getElementById('answerKey');
const shareBtn = document.getElementById('shareBtn');
const settingsBtn = document.getElementById('settingsBtn');
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('overlay');
const closeDrawerBtn = document.getElementById('closeDrawer');
const soundToggle = document.getElementById('soundToggle');
const timeMultiplier = document.getElementById('timeMultiplier');
const timeMultLabel = document.getElementById('timeMultLabel');
const themeAccent = document.getElementById('themeAccent');
const leaderEl = document.getElementById('leaderboard');

/* Settings drawer */
function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); overlay.classList.add('show'); }
function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); overlay.classList.remove('show'); }
settingsBtn.addEventListener('click', openDrawer);
closeDrawerBtn.addEventListener('click', closeDrawer);
overlay.addEventListener('click', closeDrawer);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

/* Theme accent */
themeAccent.addEventListener('change', () => {
  document.documentElement.style.setProperty('--mint',
    themeAccent.value==='amber' ? '#d08a1b' :
    themeAccent.value==='cream' ? '#f6ecd6' : '#6ab9b6'
  );
});

/* Share */
shareBtn.addEventListener('click', async () => {
  const url = location.href;
  const title = "Sumptin‚Äô Scientific ‚Äî Match & Learn";
  const text = "Test your science knowledge in this quick, fun matching game!";
  if (navigator.share){
    try{ await navigator.share({title, text, url}); }catch(e){}
  }else{
    try{ await navigator.clipboard.writeText(url); ping("Link copied to clipboard!"); }
    catch{ ping("Share this link: "+url); }
  }
});

/* Core game state */
let state = { pairs: [], timeLeft: 0, timerId: null, score: 0, streak: 0, selected: null };
let cfg = {};

/* Difficulty config */
function difficultyConfig(level){
  switch(level){
    case 'easy': return { base: 100, penalty: 10, timePerPair: 18 };
    case 'medium': return { base: 120, penalty: 15, timePerPair: 11 };
    case 'hard': return { base: 150, penalty: 20, timePerPair: 7 };
  }
}

/* Selection helpers */
function selectPairs(list, level, n, topic){
  const filtered = (topic && topic!=='all') ? list.filter(i => (i.topics||[]).includes(topic)) : list.slice();
  const weight = {easy:3, medium:2, hard:1};
  const pool = [];
  filtered.forEach(item=>{
    const w = item.diff===level ? weight.easy : (item.diff==='medium'?2:1);
    for(let k=0;k<w;k++) pool.push(item);
  });
  const uniq = new Map();
  while(uniq.size < Math.min(n, filtered.length)){
    const pick = pool[Math.floor(Math.random()*pool.length)] || filtered[Math.floor(Math.random()*filtered.length)];
    uniq.set(pick.term+"|"+(pick.topics?pick.topics[0]:""), pick);
  }
  return Array.from(uniq.values());
}

/* Build UI */
function populateSubjects(){
  subjectSel.innerHTML = "";
  Object.keys(DATA).sort().forEach(k => {
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = k;
    subjectSel.appendChild(opt);
  });
  subjectSel.selectedIndex = 0;
  refreshTopics();
}
function refreshTopics(){
  topicSel.innerHTML = '<option value="all">All topics</option>';
  const subj = subjectSel.value;
  const topicSet = new Set();
  (DATA[subj] || []).forEach(item => (item.topics||[]).forEach(t=>topicSet.add(t)));
  Array.from(topicSet).sort().forEach(t => {
    const opt = document.createElement('option');
    opt.value = t; opt.textContent = t;
    topicSel.appendChild(opt);
  });
}
subjectSel.addEventListener('change', refreshTopics);

/* Cards */
const gridEl = document.getElementById('grid');
function createCards(pairs){
  gridEl.innerHTML='';
  endScreen.classList.add('hidden');
  const terms = pairs.map(p=>({kind:'term', text:p.term}));
  const defs  = pairs.map(p=>({kind:'definition', text:p.def, match:p.term, attribution:p.attribution||'', source:p.source||''}));
  const shuf = a => a.sort(()=>Math.random()-0.5);
  shuf(terms); shuf(defs);
  const cards = terms.concat(defs);
  const frag = document.createDocumentFragment();
  cards.forEach(c=>{
    const el = document.createElement('div');
    el.className='card '+c.kind;
    el.textContent=c.text;
    el.dataset.kind=c.kind;
    if(c.kind==='definition'){ el.dataset.match=c.match; if(c.attribution) el.title = c.attribution; }
    if(c.kind==='term') el.dataset.term=c.text;
    el.addEventListener('click', ()=> playClick());
    frag.appendChild(el);
  });
  gridEl.appendChild(frag);
}

function onCardClick(e){
  const el = e.target.closest('.card');
  if(!el) return;
  if(el.classList.contains('correct')) return;

  if(!state.selected){
    state.selected = el;
    el.classList.add('selected');
    return;
  }
  if(state.selected===el) return;

  const a = state.selected, b = el;
  if(a.dataset.kind===b.dataset.kind){
    a.classList.remove('selected');
    state.selected = b;
    b.classList.add('selected');
    return;
  }
  const termEl = a.dataset.kind==='term'? a : b;
  const defEl  = a.dataset.kind==='definition'? a : b;

  const isMatch = defEl.dataset.match === termEl.dataset.term;
  a.classList.remove('selected'); b.classList.remove('selected');
  if(isMatch){
    termEl.classList.add('correct');
    defEl.classList.add('correct');
    state.score += cfg.base + 10*state.streak;
    state.streak += 1;
    updateStats();
    playDing();
    ping(`+${cfg.base + 10*(state.streak-1)} points!`);
    if([...document.querySelectorAll('.card.term')].every(x=>x.classList.contains('correct'))){
      endGame();
    }
  }else{
    termEl.classList.add('wrong'); defEl.classList.add('wrong');
    setTimeout(()=>{ termEl.classList.remove('wrong'); defEl.classList.remove('wrong'); }, 350);
    state.score = Math.max(0, state.score - cfg.penalty);
    state.streak = 0;
    updateStats();
    playBuzz();
    ping(`-${cfg.penalty} points`, true);
  }
  state.selected = null;
}

function updateStats(){
  scoreEl.textContent = `‚≠ê Score: ${state.score}`;
  streakEl.textContent = `üî• Streak: ${state.streak}`;
}

function startTimer(totalSeconds){
  state.timeLeft = Math.max(10, Math.round(totalSeconds * Number(timeMultiplier.value)));
  timerEl.textContent = fmtTime(state.timeLeft);
  clearInterval(state.timerId);
  state.timerId = setInterval(()=>{
    state.timeLeft -= 1;
    if(state.timeLeft<=5) playTick();
    timerEl.textContent = fmtTime(state.timeLeft);
    if(state.timeLeft<=0){
      clearInterval(state.timerId);
      endGame();
    }
  }, 1000);
}

function fmtTime(s){
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return `‚è±Ô∏è ${m}:${ss}`;
}

function ping(msg, danger=false){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = danger ? 'rgba(211,75,87,.6)' : 'rgba(42,163,107,.6)';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 900);
}

/* High score (per subject/topic/difficulty) */
function keyHigh(subj, level, topic){ return `SS_high_${subj}_${level}_${topic||'all'}`; }
function keyStreak(subj, level, topic){ return `SS_beststreak_${subj}_${level}_${topic||'all'}`; }

function updateHighUI(subj, level, topic){
  const hs = Number(localStorage.getItem(keyHigh(subj, level, topic))||0);
  highScoreEl.textContent = `üèÜ High: ${hs}`;
}

/* Leaderboard (website) ‚Äì requires LEADERBOARD_URL */
async function postLeaderboard(entry){
  if(!LEADERBOARD_URL) return;
  try{
    await fetch(LEADERBOARD_URL, {
      method:'POST',
      mode:'cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(entry)
    });
  }catch(e){ console.warn('Leaderboard post failed', e); }
}
async function loadLeaderboard(){
  if(!LEADERBOARD_URL){ leaderEl.innerHTML = '<span class="muted">Global leaderboard pending setup.</span>'; return; }
  try{
    const res = await fetch(LEADERBOARD_URL+'?mode=read', {cache:'no-store'});
    const rows = await res.json();
    if(!rows || !rows.length){ leaderEl.innerHTML = '<span class="muted">No scores yet.</span>'; return; }
    leaderEl.innerHTML = rows.slice(0,20).map(r=>`<div class="pill">${r.date} ‚Ä¢ ${r.subject}${r.topic?'/'+r.topic:''} ‚Ä¢ ${r.level} ‚Ä¢ ${r.name||'Player'} ‚Ä¢ ${r.score}</div>`).join(' ');
  }catch(e){ leaderEl.innerHTML = '<span class="muted">Leaderboard unavailable.</span>'; }
}

/* Start/setup */
function setupGame(){
  const subj = subjectSel.value;
  const topic = topicSel.value || 'all';
  const level = difficultySel.value;
  const pairsWanted = Number(pairCountSel.value);
  cfg = difficultyConfig(level);

  const chosen = selectPairs(DATA[subj], level, pairsWanted, topic);
  state.pairs = chosen;
  state.score = 0; state.streak = 0; state.selected=null;
  updateStats();
  createCards(chosen);
  const totalTime = cfg.timePerPair * chosen.length;
  startTimer(totalTime);
  updateHighUI(subj, level, topic);
  pairsInfo.textContent = `Pairs: ${chosen.length} ‚Ä¢ ${subj}${topic!=='all'?' / '+topic:''}`;
  grid.onclick = onCardClick;
  document.getElementById('gameArea').scrollIntoView({behavior:'smooth', block:'start'});
}

async function endGame(){
  grid.innerHTML='';
  endScreen.classList.remove('hidden');
  finalScore.textContent = `Score: ${state.score}`;
  const subj = subjectSel.value;
  const level = difficultySel.value;
  const topic = topicSel.value || 'all';
  const kH = keyHigh(subj, level, topic);
  const kS = keyStreak(subj, level, topic);
  const prevH = Number(localStorage.getItem(kH)||0);
  const prevS = Number(localStorage.getItem(kS)||0);

  if(state.score > prevH){
    localStorage.setItem(kH, state.score);
    finalMsg.textContent = "New high score! Stellar work. üöÄ";
  }else{
    finalMsg.textContent = `High score to beat: ${prevH} (best streak: ${prevS})`;
  }
  if(state.streak > prevS){
    localStorage.setItem(kS, state.streak);
  }
  updateHighUI(subj, level, topic);
  // Answer key with attributions (if present)
  answerKey.innerHTML = '<h3>Answer Key</h3>' + state.pairs.map(p=>`<div class="pill"><strong>${p.term}</strong>: ${p.def}${p.attribution?` ‚Äî <em>${p.attribution}</em>`:''}</div>`).join(' ');
  playDing(); // finish sound

  // Website leaderboard entry
  const now = new Date();
  await postLeaderboard({
    date: now.toISOString().slice(0,10),
    subject: subj, topic: topic==='all'?'':topic, level,
    score: state.score, streak: state.streak,
    name: "", // optional: prompt or set from local profile
    userAgent: navigator.userAgent
  });

  // refresh leaderboard
  loadLeaderboard();
}

/* Events */
document.getElementById('startBtn').addEventListener('click', setupGame);
document.getElementById('playAgain').addEventListener('click', setupGame);
document.getElementById('revealAnswers').addEventListener('click', ()=>{
  answerKey.classList.toggle('hidden');
});

/* Init flow */
(async function init(){
  await loadCurriculum();
  populateSubjects();
  refreshTopics();
  loadLeaderboard();
  pairsInfo.textContent = "Pairs: ‚Äî ‚Ä¢ Subject: ‚Äî";
})();
</script>
</body>
</html>
